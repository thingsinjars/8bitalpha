(function($){var opts={};$.fn.dropzone=function(options){opts=$.extend({},$.fn.dropzone.defaults,options);var id=this.attr("id");var dropzone=document.getElementById(id);log("adding dnd-file-upload functionalities to element with id: "+id);if($.client.browser=="Safari"&&$.client.os=="Windows"){var fileInput=$("<input>");fileInput.attr({type:"file"});fileInput.bind("change",change);fileInput.css({'opacity':'0','width':'100%','height':'100%'});fileInput.attr("multiple","multiple");fileInput.click(function(){return false});this.append(fileInput)}else{dropzone.addEventListener("drop",drop,true);var jQueryDropzone=$("#"+id);jQueryDropzone.bind("dragenter",dragenter);jQueryDropzone.bind("dragover",dragover)}return this};$.fn.dropzone.defaults={url:"",method:"POST",numConcurrentUploads:3,printLogs:false,uploadRateRefreshTime:1000};$.fn.dropzone.newFilesDropped=function(){};$.fn.dropzone.uploadStarted=function(fileIndex,file){};$.fn.dropzone.uploadFinished=function(fileIndex,file,time){};$.fn.dropzone.fileUploadProgressUpdated=function(fileIndex,file,newProgress){};$.fn.dropzone.fileUploadSpeedUpdated=function(fileIndex,file,KBperSecond){};function dragenter(event){event.stopPropagation();event.preventDefault();return false}function dragover(event){event.stopPropagation();event.preventDefault();return false}function drop(event){var dt=event.dataTransfer;var files=dt.files;event.preventDefault();uploadFiles(files);return false}function log(logMsg){if(opts.printLogs){}}function uploadFiles(files){$.fn.dropzone.newFilesDropped();for(var i=0;i<files.length;i++){var file=files[i];var xhr=new XMLHttpRequest();var upload=xhr.upload;upload.fileIndex=i;upload.fileObj=file;upload.downloadStartTime=new Date().getTime();upload.currentStart=upload.downloadStartTime;upload.currentProgress=0;upload.startData=0;upload.addEventListener("progress",progress,false);upload.addEventListener("load",load,false);xhr.open(opts.method,opts.url);xhr.setRequestHeader("Cache-Control","no-cache");xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");xhr.setRequestHeader("X-File-Name",file.fileName);xhr.setRequestHeader("X-File-Size",file.fileSize);xhr.setRequestHeader("Content-Type","multipart/form-data");xhr.send(file);$.fn.dropzone.uploadStarted(i,file)}}function load(event){var now=new Date().getTime();var timeDiff=now-this.downloadStartTime;$.fn.dropzone.uploadFinished(this.fileIndex,this.fileObj,timeDiff);log("finished loading of file "+this.fileIndex)}function progress(event){if(event.lengthComputable){var percentage=Math.round((event.loaded*100)/event.total);if(this.currentProgress!=percentage){this.currentProgress=percentage;$.fn.dropzone.fileUploadProgressUpdated(this.fileIndex,this.fileObj,this.currentProgress);var elapsed=new Date().getTime();var diffTime=elapsed-this.currentStart;if(diffTime>=opts.uploadRateRefreshTime){var diffData=event.loaded-this.startData;var speed=diffData/diffTime; $.fn.dropzone.fileUploadSpeedUpdated(this.fileIndex,this.fileObj,speed);this.startData=event.loaded;this.currentStart=elapsed}}}}function change(event){event.preventDefault();var files=this.files;uploadFiles(files)}})(jQuery);